## ç¯å¢ƒå®‰è£…å’Œé…ç½®

> ä»¥ Centos ä¸ºä¾‹

### 1. æ›´æ”¹ä¸»æœºåç§°
   ```
   hostnamectl set-hostname docker-learn && bash
   ```
   `bash` ï¼šæ›´æ–°ç¯å¢ƒå˜é‡

### 2. ç¦ç”¨é˜²ç«å¢™

   1. åœæ­¢
        ```
        systemctl stop firewalld
        ```

   1. ç¦ç”¨
        ```
        systemctl disable firewalld
        ```

        å¦‚é‡æŠ¥é”™`Failed to disable unit: Access denied`
        ```
        sudo systemctl disable firewalld
        ```
### 3. ç¦ç”¨ SELinux
   
   SELinuxä»£è¡¨å®‰å…¨å¢å¼ºå‹Linuxï¼ˆSecurity-Enhanced Linuxï¼‰ï¼Œå®ƒæ˜¯Linuxå†…æ ¸çš„ä¸€ä¸ªå®‰å…¨æ¨¡å—ï¼Œæ—¨åœ¨æä¾›å¼ºåŒ–çš„è®¿é—®æ§åˆ¶å’Œå®‰å…¨ç­–ç•¥æœºåˆ¶ã€‚å®ƒé€šè¿‡å¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰æœºåˆ¶ï¼Œä¸ºLinuxç³»ç»Ÿæä¾›äº†æ›´ç»†ç²’åº¦çš„å®‰å…¨ç­–ç•¥ã€‚

   1. ä¸´æ—¶ç¦ç”¨
      ```
      sudo setenforce 0
      ```
      å‘½ä»¤ä¸­çš„ setenforce æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºä¿®æ”¹SELinuxçš„æ‰§è¡Œæ¨¡å¼ã€‚SELinuxæœ‰ä¸‰ç§æ‰§è¡Œæ¨¡å¼ï¼š

      - Enforcingï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰ï¼šåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒSELinuxä¼šå¼ºåˆ¶æ‰§è¡Œå®‰å…¨ç­–ç•¥ï¼Œé˜»æ­¢æœªç»æˆæƒçš„è®¿é—®ã€‚

      - Permissiveï¼ˆå®½å®¹æ¨¡å¼ï¼‰ï¼šåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒSELinuxä¼šè®°å½•ä½†ä¸é˜»æ­¢è¿è§„æ“ä½œï¼Œé€šå¸¸ç”¨äºè¯Šæ–­å’Œè°ƒè¯•ã€‚

      - Disabledï¼ˆç¦ç”¨ï¼‰ï¼šè¿™ä¸ªçŠ¶æ€ä¸‹ï¼ŒSELinuxè¢«å®Œå…¨ç¦ç”¨ï¼Œä¸ä¼šå¯¹ç³»ç»Ÿè¿›è¡Œä»»ä½•è®¿é—®æ§åˆ¶ã€‚

      æ‰§è¡Œ `sudo setenforce 0` ä¼šå°†SELinuxåˆ‡æ¢åˆ°å®½å®¹æ¨¡å¼ï¼ˆPermissiveï¼‰ï¼Œè¿™æ„å‘³ç€SELinuxä¼šè®°å½•è¿åå®‰å…¨ç­–ç•¥çš„æ“ä½œï¼Œä½†ä¸ä¼šé˜»æ­¢å®ƒä»¬ã€‚è¿™åœ¨è¯Šæ–­ç³»ç»Ÿé—®é¢˜æ—¶å¯èƒ½æœ‰ç”¨ï¼Œå› ä¸ºä½ å¯ä»¥æŸ¥çœ‹SELinuxæ—¥å¿—ï¼Œäº†è§£å“ªäº›æ“ä½œè¢«æ‹¦æˆªã€‚

      éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§ä¿®æ”¹åªæ˜¯ä¸´æ—¶çš„ã€‚ä¸€æ—¦ç³»ç»Ÿé‡å¯ï¼ŒSELinuxä¼šæ¢å¤åˆ°å®ƒä¹‹å‰çš„çŠ¶æ€ã€‚

   2. æ°¸ä¹…ç¦ç”¨    
      æ›´æ”¹é…ç½®æ–‡ä»¶
      ```
      sudo vi /etc/selinux/config
      ```
      ä¿®æ”¹ä¸º
      ```
      # SELINUX=enforcing
      SELINUX=disabled
      ```
      é‡å¯
      ```
      reboot
      ```
      éªŒè¯
      ```
      getenforce
      ```
      è‹¥ä¿®æ”¹æˆåŠŸï¼Œåˆ™è¾“å‡º`DISABLED`

### 4. æ—¶é—´åŒæ­¥
   1. å®‰è£…åŒæ­¥è½¯ä»¶ ntpdate
   
      Centos < 8ï¼š
      ```
      yum install -y ntpdate

      é…ç½® ntpdate æ—¶é—´æº
      ntpdate cn.pool.ntp.org
      ```

      Centos >= 8: ä½¿ç”¨ chrony
      ```
      yum install -y chrony

      Â·
      Â·
      Â·
      ```

## å®‰è£… docker

> docker-ce ç¤¾åŒºç‰ˆ

### 1. é…ç½®å›½å†… yum æºï¼ˆé˜¿é‡Œäº‘ï¼‰
   ```
   yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
   ```

### 2. å®‰è£… docker ä¾èµ–åŒ…
   ```
   yum install -y yum-utils device-mapper-persistent-data lvm2
   ```

### 3. å®‰è£… docker-ce
   ```
   yum install -y docker-ce
   ```

### 4. æŸ¥çœ‹ç‰ˆæœ¬
   ```
   docker version
   ```

### 5. å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨
   ```
   systemctl start docker && systemctl enable docker
   ```

### 6. æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
   ```
   systemctl status docker
   ```

   ---

### 7. ä¿®æ”¹å†…æ ¸å‚æ•°ã€å¼€å¯åŒ…è½¬å‘åŠŸèƒ½  
   - å†…æ ¸å‚æ•°ä¿®æ”¹ï¼šbr_netfilter æ¨¡å—ç”¨äºå°†æ¡¥æ¥æµé‡è½¬å‘è‡³ iptables é“¾
  
      åŠ è½½å†…æ ¸æ¨¡å—
      ```
      modprobe br_netfilter
      ```
      >modprobe æ˜¯ä¸€ä¸ªç”¨äºç®¡ç† Linux å†…æ ¸æ¨¡å—çš„å‘½ä»¤ã€‚Linux å†…æ ¸æ¨¡å—æ˜¯ä¸€ç§åŠ¨æ€åŠ è½½åˆ°å†…æ ¸ä¸­çš„è½¯ä»¶ç»„ä»¶ï¼Œç”¨äºæ·»åŠ æ–°çš„åŠŸèƒ½ã€è®¾å¤‡é©±åŠ¨æˆ–ä¿®æ”¹å†…æ ¸è¡Œä¸ºã€‚

      >modprobe å‘½ä»¤å…è®¸ä½ åœ¨è¿è¡Œæ—¶åŠ è½½ã€å¸è½½ã€åˆ—å‡ºå’Œç®¡ç†è¿™äº›å†…æ ¸æ¨¡å—ã€‚å®ƒé€šå¸¸ç”¨äºåŠ è½½ç‰¹å®šçš„é©±åŠ¨ç¨‹åºæˆ–æ·»åŠ æ‰€éœ€çš„å†…æ ¸æ¨¡å—ï¼Œä»¥ä¾¿æ“ä½œç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒæ–°çš„ç¡¬ä»¶è®¾å¤‡æˆ–ç‰¹å®šçš„åŠŸèƒ½ã€‚

   - å¼€å¯åŒ…è½¬å‘ï¼š
     - é…ç½®é…ç½®æ–‡ä»¶ï¼š
        ```
        cat > /etc/sysctl.d/docker.conf <<EOF
        net.bridge.bridge-nf-call-ip6tables = 1
        net.bridge.bridge-nf-call-iptables = 1
        net.ipv4.ip_forward = 1
        EOF
        ```

        `net.bridge.bridge-nf-call-ip6tables = 1`  
        `net.bridge.bridge-nf-call-iptables = 1`  
        å¯è§£å†³ WARNING: bridge-nf-call-iptables is disabled

        `net.ipv4.ip_forward = 1`  
        å°†Linuxç³»ç»Ÿä½œä¸ºè·¯ç”±æˆ–è€…VPNæœåŠ¡å°±å¿…é¡»è¦å¼€å¯IPè½¬å‘åŠŸèƒ½ã€‚å½“linuxä¸»æœºæœ‰å¤šä¸ªç½‘å¡æ—¶ä¸€ä¸ªç½‘å¡æ”¶åˆ°çš„ä¿¡æ¯æ˜¯å¦èƒ½å¤Ÿä¼ é€’ç»™å…¶ä»–çš„ç½‘å¡ ï¼Œå¦‚æœè®¾ç½®æˆ1 çš„è¯ å¯ä»¥è¿›è¡Œæ•°æ®åŒ…è½¬å‘ï¼Œå¯ä»¥å®ç°VxLAN ç­‰åŠŸèƒ½ã€‚ä¸å¼€å¯ä¼šå¯¼è‡´dockeréƒ¨ç½²åº”ç”¨æ— æ³•è®¿é—®

      - åŠ è½½å¹¶åº”ç”¨
         ```
         sysctl -p /etc/sysctl.d/docker.conf
         ```
         > sysctlï¼šç”¨äºæŸ¥çœ‹å’Œä¿®æ”¹å†…æ ¸è¿è¡Œæ—¶å‚æ•°çš„å·¥å…·ã€‚

         >-pï¼šè¡¨ç¤º "load in sysctl settings from the file specified or /etc/sysctl.conf if none given"ï¼Œå³ä»æŒ‡å®šçš„æ–‡ä»¶åŠ è½½ç³»ç»Ÿå‚æ•°è®¾ç½®ã€‚

      é‡å¯åæ¨¡å—å¤±æ•ˆï¼Œé…ç½®å¼€æœºè‡ªåŠ¨åŠ è½½æ¨¡å—çš„è„šæœ¬

      - åˆ›å»ºæ–‡ä»¶ rc.sysinit
         ```
         cat /etc/rc.sysinit
         ```
         > åœ¨ Linux å¼•å¯¼è¿‡ç¨‹ä¸­ï¼Œrc.sysinit è´Ÿè´£æ‰§è¡Œä¸€äº›åŸºæœ¬çš„ç³»ç»Ÿåˆå§‹åŒ–ä»»åŠ¡
     - å†™å…¥å¾ªç¯åŠ è½½é€»è¾‘
         ```
         #!/bin/bash
         for file in /etc/sysconfig/modules/*.modules ; do
         [ -x $file ] && $file
         done
         ```
      - åˆ›å»ºæ–‡ä»¶ br_netfilter.modules
         ```
         cat /etc/sysconfig/modules/br_netfilter.modules
         ```
      - å†™å…¥å†…æ ¸æ¨¡å—åŠ è½½å‘½ä»¤
         ```
         modprobe br_netfilter
         ```
      - å¢åŠ æƒé™
         ```
         chmod 755 /etc/sysconfig/modules/br_netfilter.modules
         ```
   ---
### 8. é…ç½®é•œåƒåŠ é€Ÿ  
   - é…ç½®é•œåƒåœ°å€
      ```
      vi /etc/docker/daemon.json
      ```
      ```
      "registry-mirrors":["https://y8y6vosv.mirror.aliyuncs.com","https://registry.docker-cn.com","https://docker.mirrors.ustc.edu.cn","https://dockerhub.azk8s.cn","http://hub-mirror.c.163.com"]
      ```
   - ä½¿ç”Ÿæ•ˆ
      ```
      sudo systemctl daemon-reload
      sudo systemctl restart docker
      ```
   é˜¿é‡Œäº‘é•œåƒåœ°å€æŸ¥çœ‹ï¼šhttps://cr.console.aliyun.com/cn-hangzhou/instances/mirrors

   ![å›¾ç¤º](../_media/çŒé­”ç¬”è®°/docker/é•œåƒåˆ—è¡¨.png)

## é•œåƒæ“ä½œ (ä»¥centosé•œåƒä¸ºä¾‹)
### 1. æŸ¥æ‰¾
   ```
   docker search centos
   ```
### 2. ä¸‹è½½
   ```
   docker pull centos
   ```
### 3. æŸ¥çœ‹æœ¬åœ°é•œåƒ
   ```
   docker images
   ```
### 4. æŠŠé•œåƒåšæˆç¦»çº¿å‹ç¼©åŒ…
   ```
   docker save -o centos.tar.gz centos
   ```  

   `-o` ä¸ºæŒ‡å®šè¾“å‡º
### 5. è§£å‹ç¦»çº¿é•œåƒåŒ…
   ```
   docker load -i centos.tar.gz
   ```
### 6. åˆ é™¤é•œåƒ
   ```
   docker rmi -f centos:latest
   ```

### 7. å¸¸ç”¨å‘½ä»¤
   - æŸ¥çœ‹æœåŠ¡çŠ¶æ€
      ```
      systemctl status docker
      ```

   - æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨
      ```
      docker ps
      ```

   - äº§çœ‹æ‰€æœ‰å®¹å™¨
      ```
      docker ps -a
      ```
   
   - åœæ­¢å®¹å™¨
      ```
      docker stop hello1
      ```

   - å¯åŠ¨å·²ç»åœæ­¢çš„å®¹å™¨
      ```
      docker start hello1
      ```
   
   - è¿›å…¥å®¹å™¨
      ```
      docker exec -it hello1 /bin/bash
      ```
   
   - å¼ºåˆ¶åˆ é™¤å®¹å™¨
      ```
      docker rm -f hello1
      ```

   - æŸ¥çœ‹dockerå¸®åŠ©å‘½ä»¤
      ```
      docker --help
      ```

   - äº§çœ‹è¯¦ç»†ä¿¡æ¯
      ```
      docker inspect å®¹å™¨åç§°/id
      ```
   ---
   - æ„å»ºé•œåƒ

      ```
      docker build -t="é•œåƒå:ç‰ˆæœ¬å·" -f æŒ‡å®šçš„Dockerfileè·¯å¾„ .
      ```
   - æŸ¥çœ‹æœ¬åœ°æ‰€æœ‰é•œåƒ
      ```
      docker images
      ```
      - è¿‡æ»¤
      ```
      docker images | grep xxx
      ```
   - é‡å‘½åé•œåƒ
      ```
      docker tag æ—§é•œåƒå:æ—§ç‰ˆæœ¬å· æ–°é•œåƒå:æ–°ç‰ˆæœ¬å·
      ```
      å®é™…ä¸Šæ˜¯ä¸ºè¯¥é•œåƒæ·»åŠ ä¸€ä¸ªæ–°æ ‡ç­¾ï¼Œæ­¤æ—¶æ–°æ—§æ ‡ç­¾å…±å­˜

   - åˆ é™¤é•œåƒ
      ```
      docker rmi é•œåƒå:ç‰ˆæœ¬å·
      ```
      å®é™…ä¸Šå°±æ˜¯åˆ é™¤æ ‡ç­¾ï¼Œå½“åˆ é™¤æœ€åä¸€ä¸ªæ ‡ç­¾çš„æ—¶å€™ï¼Œé•œåƒå³è¢«åˆ é™¤
   ---
   - è¿è¡Œé•œåƒ / åŸºäºé•œåƒåˆ›å»ºå®¹å™¨
      ```
      docker run -d -p 80 --name åˆ›å»ºçš„å®¹å™¨å é•œåƒå:ç‰ˆæœ¬å·
      ```
   - æŸ¥çœ‹å®¹å™¨æ—¥å¿—
      ```
      docker logs å®¹å™¨å
      ```
      ```
      docker logs -f -t --since=20m --tail=10 å®¹å™¨å
      ```
      - -f å®æ—¶æŸ¥çœ‹
      - -t æ˜¾ç¤ºæ—¶é—´æˆ³
      - --since æ˜¾ç¤ºæŒ‡å®šæ—¶é—´ä¹‹åçš„æ—¥å¿—
      - --tail æ˜¾ç¤ºæœ€æ–°Næ¡æ—¥å¿—

   - è¿›å…¥å®¹å™¨
      - ä»¥äº¤äº’å¼æ–¹å¼å¯åŠ¨å¹¶è¿›å…¥å®¹å™¨
         ```
         docker run --name=hello -it centos /bin/bash
         ```
         - --nameï¼šæŒ‡å®šå®¹å™¨åç§°
         - -iï¼šäº¤äº’å¼
         - -tï¼šåˆ†é…ä¼ªç»ˆç«¯
         - /bin/bashï¼šè¯´æ˜ shell ç±»å‹ä¸º bash
           
      - ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼å¯åŠ¨å®¹å™¨
         ```
         docker run --name=hello1 -td centos
         ```
         - -dï¼šåœ¨åå°è¿è¡Œ

         äº§çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨
         ```
         docker ps
         ```
         
         è¿›å…¥å®¹å™¨
         ```
         docker exec -it hello1 /bin/bash
         ```

      - æˆ–
        ```
        docker attach <å®¹å™¨IDæˆ–åç§°>
        ```

      ---

      æŸäº›è½»é‡çº§åŸºç¡€é•œåƒä¸åŒ…å« bashï¼Œè€ŒåªåŒ…å«sh
      ```
      docker exec -it <å®¹å™¨IDæˆ–åç§°> /bin/sh
      ```


      

## Dockerfile

>[å‚è€ƒï¼š51CTO](https://blog.51cto.com/u_16099335/7334441)

---

1. `FROM` åŸºç¡€é•œåƒ
   ```
   FROM centos
   ```
   æŒ‡å®šåŸºç¡€é•œåƒ ä¸º centos

2. `MAINTAINER` ä½œè€…
   
   ```
   MAINTAINER xxx
   ```

3. `RUN` æŒ‡å®šå½“å‰é•œåƒæ„å»ºæ—¶è¿è¡Œçš„ linux å‘½ä»¤

   ```
   RUN <command> 
   ```

   ğŸŒ° Shell æ¨¡å¼
   ```
   RUN echo hello_docker
   ```

   ğŸŒ° exec æ¨¡å¼
   ```
   RUN ["æŒ‡å®š Shell","å‘½ä»¤å‚æ•°","å‘½ä»¤"]

   RUN ["/bin/shell","-c","echo hello_docker"]
   ```

   - -c æŒ‡å®šåç»­æ˜¯ä¸€æ¡å‘½ä»¤

4. `EXPOSE` æŒ‡å®šç«¯å£ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰
   ```
   EXPOSE 80 81 
   ```

   - -P å°†æš´éœ²çš„ç«¯å£åœ¨ç‰©ç†æœºè¿›è¡Œéšæœºæ˜ å°„
      ```
      docker run -P
      ```
   - -p è¿›è¡Œå®¹å™¨ç«¯å£æ˜ å°„æŒ‡å®š
      ```
      docker run -p ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£      
      ```
      ```
      docker run -p å®¹å™¨ç«¯å£
      ```
      ä¸æŒ‡å®šä¸»æœºç«¯å£åˆ™ä¼šéšæœºè¿›è¡Œæ˜ å°„

5. `CMD` æŒ‡å®šé•œåƒè¿è¡Œæ—¶å‘½ä»¤
   
   CMD åœ¨é•œåƒè¿è¡Œ (docker run) æ—¶æ‰§è¡Œ , å¯ä»¥ç”¨äºè¿è¡Œæ—¶å¯åŠ¨æŸäº›åŠŸèƒ½
   ```
   CMD ["","",""]
   ```
   ```
   CMD echo hello_docker
   ```
   å¤šæ¡ CMD å‘½ä»¤ ä»…æœ€åä¸€æ¡ä¼šç”Ÿæ•ˆ

6. `ENTRYPOINT`
   
   ENTRYPOINT ç±»ä¼¼ CMD ä½†æ˜¯ä¸ä¼šè¢« docker run å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šçš„å‘½ä»¤è¦†ç›–ï¼Œè€Œä¸”è¿™äº›å‘½ä»¤ä¼šä½œä¸ºå‚æ•°èµ‹ç»™ ENTRYPOINT æ‰€æŒ‡å®šçš„ç¨‹åºå‘½ä»¤
   ```
   FROM nginx
   ENTERYPOINT ["nginx","-c"] # å®šå‚
   CMD ["/etc/nginx/nginx.conf"] # å˜å‚
   ```

   - è¿è¡Œæ—¶ä¼ é€’å˜å‚
      ```
      docker run --name a_container_name:customer_tag /etc/nginx/other.conf
      ```

   è‹¥ docker run æŒ‡å®š --entrypoint ï¼Œåˆ™ä¾ç„¶è¦†ç›– ENTRYPOINT å‘½ä»¤
   ```
   ENTRYPOINT ["","",""]

   ENTRYPOINT echo hello_docker
   ```

   å¤šæ¡ ENTRYPOINT å‘½ä»¤ï¼Œä»…æœ€åä¸€æ¡ç”Ÿæ•ˆ

7. `COPY` å¤åˆ¶æŒ‡å®šæ–‡ä»¶åˆ°ç›®æ ‡è·¯å¾„

   ```
   COPY [--chown=<user>:<group>] <æºè·¯å¾„> <ç›®æ ‡è·¯å¾„>
   ```
   - `[--chown=<user>:<group>]` ï¼šå¯é€‰å‚æ•°ï¼Œæ”¹å˜å¤åˆ¶åˆ°å®¹å™¨å†…çš„æ–‡ä»¶çš„æ‹¥æœ‰è€…å’Œå±ç»„
   - `<æºè·¯å¾„>`ï¼šå¯ä½¿ç”¨æ»¡è¶³ GO çš„ filepath.Match è§„åˆ™çš„é€šé…ç¬¦
   
     ```
     COPY hom* /dir/
     ```
     ```
     COPY hom?.txt /dir/
     ```
   - `<ç›®æ ‡è·¯å¾„>`ï¼šä¸å¿…äº‹å…ˆå»ºç«‹ï¼Œè‹¥ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º

8. `ADD` è‡ªåŠ¨è§£å‹å‹ç¼©åŒ…å†…å®¹å¹¶å¤åˆ¶åˆ°æŒ‡å®šè·¯å¾„ä¸‹
   
   ç±»ä¼¼ COPY

9. `VOLUME` å· - æŒ‚è½½æŒä¹…æ•°æ®

   æ•°æ®å·æ˜¯ç»è¿‡ç‰¹æ®Šè®¾è®¡çš„ç›®å½•ï¼Œå¯ä»¥ç»•è¿‡è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUFSï¼‰ï¼Œä¸ºä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨æä¾›è®¿é—®ï¼Œæ•°æ®å·è®¾è®¡çš„ç›®çš„ï¼Œåœ¨äºæ•°æ®çš„æ°¸ä¹…å­˜å‚¨ï¼Œå®ƒå®Œå…¨ç‹¬ç«‹äºå®¹å™¨çš„ç”Ÿå­˜å‘¨æœŸï¼Œå› æ­¤ï¼Œdocker ä¸ä¼šåœ¨å®¹å™¨åˆ é™¤æ—¶åˆ é™¤å…¶æŒ‚è½½çš„æ•°æ®å·ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨ç±»ä¼¼çš„åƒåœ¾æ”¶é›†æœºåˆ¶ï¼Œå¯¹å®¹å™¨å¼•ç”¨çš„æ•°æ®å·è¿›è¡Œå¤„ç†ï¼ŒåŒä¸€ä¸ªæ•°æ®å·å¯ä»¥åªæ”¯æŒå¤šä¸ªå®¹å™¨çš„è®¿é—®ã€‚

   - ç‰¹ç‚¹ï¼š

      1. æ•°æ®å·åœ¨å®¹å™¨å¯åŠ¨æ—¶åˆå§‹åŒ–ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨çš„é•œåƒåœ¨æŒ‚è½½ç‚¹åŒ…å«äº†æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¼šè¢«æ‹·è´åˆ°æ–°åˆå§‹
      åŒ–çš„æ•°æ®å·ä¸­
      2. æ•°æ®å·å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«å’Œé‡ç”¨
      3. å¯ä»¥å¯¹æ•°æ®å·é‡Œçš„å†…å®¹ç›´æ¥è¿›è¡Œä¿®æ”¹
      4. æ•°æ®å·çš„å˜åŒ–ä¸ä¼šå½±åƒé•œåƒçš„æ›´æ–°
      5. å·ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿æŒ‚è½½æ•°æ®å·çš„å®¹å™¨å·²ç»è¢«åˆ é™¤

   - è¯­æ³•
      ```
      VOLUMN ["/data"]
      ``` 

      åœ¨å®¹å™¨ä¸­åˆ›å»º `/data` ç›®å½•å¹¶æŒ‚è½½äºç‰©ç†æœºä¸‹ï¼Œç›¸äº’åŒæ­¥  
      é»˜è®¤æŒ‚è½½åœ¨ `docker/å®¹å™¨å/å®¹å™¨id/data` ä¸‹

   - æŒ‡å®šæŒ‚è½½ä½ç½®
     ```
     docker run --name volume_test -v /æŒ‡å®šçš„ç‰©ç†æœºç›®å½•:/data -d -P é•œåƒå:tagåç§°
     ```
     æŒ‡å®šçš„ç‰©ç†æœºç›®å½• ä¼šè‡ªåŠ¨åˆ›å»º

     ```
     docker run --name volume_test -v ~/æŒ‡å®šçš„ç‰©ç†æœºç›®å½•:/data -d -P é•œåƒå:tagåç§°
     ```

     - ~ ä»£è¡¨å½“å‰ç”¨æˆ·çš„å®¶ç›®å½•ï¼š`/root`
         
   - æŒ‡å®šå¤šä¸ª
      ```
      VOLUMN ["/data1","/data2"]
      ```

   - ä¸ºæ•°æ®å·æ·»åŠ è®¿é—®æƒé™
     ```
     docker run --name volume_test -v /æŒ‡å®šçš„ç‰©ç†æœºç›®å½•:/data:ro -d -P é•œåƒå:tagåç§°
     ```
     - ro : åªè¯»
     - æ·»åŠ åªè¯»æƒé™ä¹‹ååœ¨ docker å®¹å™¨çš„ /data ç›®å½•ä¸‹ä¸å†èƒ½åˆ›å»ºæ–‡ä»¶
     - å®¿ä¸»æœºä¸‹çš„ /æŒ‡å®šçš„ç‰©ç†æœºç›®å½• ä¸‹å¯åˆ›å»ºå†…å®¹

   ---
   ---

   - æ•°æ®å·å®¹å™¨
      > å‘½åçš„å®¹å™¨æŒ‚è½½æ•°æ®å·ï¼Œå…¶ä»–å®¹å™¨é€šè¿‡æŒ‚è½½è¿™ä¸ªå®¹å™¨å®ç°æ•°æ®å…±äº«ï¼ŒæŒ‚è½½æ•°æ®å·çš„å®¹å™¨ï¼Œå°±å«åšæ•°æ®å·å®¹å™¨

      - æŒ‚è½½(åº”ç”¨)æ•°æ®å·å®¹å™¨
        ```
        docker run --volumes-from [container name]
        ```

   - å·çš„å¤‡ä»½å’Œè¿˜åŸ
     - å¤‡ä»½
       ```
       docker run --volumes-from åŒ…å«è¦å¤‡ä»½çš„é•œåƒçš„å®¹å™¨å -v /æŒ‡å®šçš„å®¿ä¸»æœºä¿å­˜è·¯å¾„:/å®¹å™¨å†…ä¿å­˜å¤‡ä»½è·¯å¾„ --name è¦è¿è¡Œçš„å®¹å™¨åç§° é•œåƒå tar zcvf /å®¹å™¨å†…ä¿å­˜å¤‡ä»½è·¯å¾„/å¤‡ä»½æ–‡ä»¶å.tar.gz /å®¹å™¨å†…æ•°æ®å·è·¯å¾„
       ```

       - é•œåƒåï¼šå½“å‰å®¹å™¨è¿è¡Œçš„åŸºç¡€é•œåƒ
         - centos ï¼šå¯ä»¥ï¼Œä½†æ˜¯å¿’å¤§äº†
         - alpine ï¼šå¯ä»¥ï¼Œä¸å¤§
       - tar zcvf ï¼šå‹ç¼©å‘½ä»¤
         - cï¼šåˆ›å»ºæ–°çš„å½’æ¡£æ–‡ä»¶ã€‚
         - zï¼šä½¿ç”¨ gzip å‹ç¼©å½’æ¡£æ–‡ä»¶ã€‚
         - vï¼šæ˜¾ç¤ºè¯¦ç»†çš„è¾“å‡ºä¿¡æ¯ï¼Œä»¥ä¾¿æŸ¥çœ‹å½’æ¡£æˆ–è§£å‹çš„è¿‡ç¨‹ã€‚
         - fï¼šæŒ‡å®šå½’æ¡£æ–‡ä»¶çš„åç§°ã€‚
  
     - è¿˜åŸ
       ```
       docker run --volumes-from åŒ…å«è¦è¿˜åŸçš„é•œåƒçš„å®¹å™¨å -v /æŒ‡å®šçš„å®¿ä¸»æœºä¿å­˜è·¯å¾„:/å®¹å™¨å†…ä¿å­˜å¤‡ä»½è·¯å¾„ --name è¦è¿è¡Œçš„å®¹å™¨åç§° é•œåƒå tar xzvf /å®¹å™¨å†…ä¿å­˜å¤‡ä»½è·¯å¾„/å¤‡ä»½æ–‡ä»¶å.tar.gz -C /å®¹å™¨å†…æ•°æ®å·è·¯å¾„
       ```
       - tar xzvf ï¼šè§£å‹ç¼©å‘½ä»¤
         - xï¼šæå–å½’æ¡£æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚
         - zï¼šä½¿ç”¨ gzip è§£å‹ç¼©å½’æ¡£æ–‡ä»¶ã€‚
         - vï¼šæ˜¾ç¤ºè¯¦ç»†çš„è¾“å‡ºä¿¡æ¯ï¼Œä»¥ä¾¿æŸ¥çœ‹è§£å‹çš„è¿‡ç¨‹ã€‚
         - fï¼šæŒ‡å®šè¦è§£å‹çš„å½’æ¡£æ–‡ä»¶çš„åç§°ã€‚
     
     ---
      ç›´æ¥å‹ç¼©æŒ‚è½½æ–‡ä»¶å¤šæ–¹ä¾¿ ...

   ---

10.   `WORKDIR` æŒ‡å®šå·¥ä½œç›®å½•  
    
    å¿…é¡»æ˜¯æå‰åˆ›å»ºå¥½çš„
    ```
    WORKDIR /path/work
    ```
    åˆ™åˆ›å»ºå®¹å™¨åè¿›å…¥åä¼šé»˜è®¤è¿›å…¥ `/path/work`

    >é€šè¿‡WORKDIRè®¾ç½®å·¥ä½œç›®å½•åï¼ŒDockerfileä¸­å…¶åçš„å‘½ä»¤RUNã€CMDã€ENTRYPOINTã€ADDã€COPYç­‰å‘½ä»¤éƒ½ä¼šåœ¨è¯¥ç›®å½•ä¸‹æ‰§è¡Œã€‚åœ¨ä½¿ç”¨docker runè¿è¡Œå®¹å™¨æ—¶ï¼Œå¯ä»¥é€šè¿‡-wå‚æ•°è¦†ç›–æ„å»ºæ—¶æ‰€è®¾ç½®çš„å·¥ä½œç›®å½•ã€‚

11.   `ENV` è®¾ç½®ç¯å¢ƒå˜é‡  
    ```
    ENV <key> <value>

    ENV <key>=<value>
    ```
    è®¾ç½®çš„ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥åœ¨åç»­å‘½ä»¤ä¸­ä»¥ $key å¼•ç”¨ï¼›
    ```
    ENV NODE_VERSION=12.22.2

    RUN curl -SLO "https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz"
    ```

12.   `USER` æŒ‡å®šæ‰§è¡Œåç»­å‘½ä»¤çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„
    
    ç”¨æˆ·å’Œç”¨æˆ·ç»„å¿…é¡»å·²ç»å­˜åœ¨ï¼›

    ```
    USER <ç”¨æˆ·å>[:<ç”¨æˆ·ç»„>]
    ```
    ```
    USER user
    USER uid
    USER user:group
    ```

13.   `ONBUILD` 
    
    åˆ›å»ºç¬¬ä¸€ä¸ªé•œåƒçš„ dockerfile_onbuild
    ```
    Â·Â·Â·
    ONBUILD COPY A.html /B/
    ONBUILD echo hello_docker
    Â·Â·Â·
    ```
    æ„å»ºç¬¬ä¸€ä¸ªé•œåƒ
    ```
    docker build -t="onbuild-test:v1" -f dockerfile_onbuild . --load
    ```

    ---
    
    åˆ›å»ºåº”ç”¨ç¬¬ä¸€ä¸ªé•œåƒçš„ dockerfile_useonbuild
    ```
    FROM onbuild:v1
    Â·Â·Â·
    ```

    åœ¨æ„å»ºç¬¬äºŒä¸ªé•œåƒçš„æ—¶å€™
    ```
    docker build -t="onbuild-test:v2" -f dockerfile_useonbuild . --load
    ```
    > ä¼šé»˜è®¤ä» dockerhub æŸ¥æ‰¾åŸºç¡€é•œåƒ - ã€æœªè§£ã€‘
    
    æ­¤æ—¶ä¼šæ‰§è¡Œ dockerfile_onbuild ä¸­çš„å‘½ä»¤

---

## æ„å»ºé•œåƒ

```
docker build -t="é•œåƒå:ç‰ˆæœ¬å·" -f æŒ‡å®šçš„Dockerfileè·¯å¾„ .
```
æœ€åçš„ `.` ä»£è¡¨æ„å»ºçš„æ˜¯å½“å‰ç›®å½•

## å®¹å™¨äº’è”

### docker å®¹å™¨çš„ç½‘ç»œåŸºç¡€çŸ¥è¯†
   1. docker0
   
      å®‰è£…dockerçš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸€ä¸ªdocker0çš„è™šæ‹Ÿç½‘æ¡¥

      å¯ä»¥ä½¿ç”¨ `ip addr` æŸ¥çœ‹

      ```
      ...
      docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
         link/ether 02:42:28:ae:c0:42 brd ff:ff:ff:ff:ff:ff
         inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
            valid_lft forever preferred_lft forever
         inet6 fe80::42:28ff:feae:c042/64 scope link
      ...
      ```
   
   2. Linux è™šæ‹Ÿç½‘æ¡¥çš„ç‰¹ç‚¹

      - å¯ä»¥è®¾ç½®ipåœ°å€
      - ç›¸å½“äºæ‹¥æœ‰ä¸€ä¸ªéšè—çš„è™šæ‹Ÿç½‘å¡
      - æ¯è¿è¡Œä¸€ä¸ª docker å®¹å™¨éƒ½ä¼šç”Ÿæˆä¸€ä¸ª veth è®¾å¤‡å¯¹ï¼Œè¿™ä¸ª veth ä¸€ä¸ªæ¥å£åœ¨å®¹å™¨é‡Œï¼Œä¸€ä¸ªæ¥å£åœ¨ç‰©ç†æœºä¸Šã€‚

   3. ç½‘æ¡¥ç®¡ç†å·¥å…·
      ```
      yum install bridge-utils -y
      ```
      - æŸ¥çœ‹ç½‘æ¡¥ä¿¡æ¯
         ```
         brctl show
         ```
## ç½‘ç»œæ¨¡å¼ --net
   
   docker run åˆ›å»º Docker å®¹å™¨æ—¶ï¼Œå¯ä»¥ç”¨ `--net` é€‰é¡¹æŒ‡å®šå®¹å™¨çš„ç½‘ç»œæ¨¡å¼ 
   - bridge æ¨¡å¼ï¼š--net=bridge  é»˜è®¤è®¾ç½®
     
     å®¹å™¨å¯åŠ¨åä¼šé€šè¿‡DHCPè·å–ä¸€ä¸ªåœ°å€

   - host æ¨¡å¼ï¼š--net=host
     
     å…±äº«å®¿ä¸»æœºçš„ç½‘ç»œ

     - å®¹å™¨ä¸å®¿ä¸»æœºå…±äº«ä¸€ä¸ªç½‘ç»œæ ˆï¼Œå®¹å™¨ä¸­çš„åº”ç”¨å¯ä»¥ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œè®¾å¤‡ï¼Œæ¯”å¦‚ï¼šping å®¿ä¸»æœºï¼Œæˆ–è€…å®‰è£…ç½‘ç»œç®¡ç†å·¥å…·ï¼Œæ¯”å¦‚ï¼šifconfigï¼Œipç­‰ã€‚

   - none æ¨¡å¼ï¼š--net=none
     
      åˆ›å»ºçš„å®¹å™¨æ²¡æœ‰ç½‘ç»œåœ°å€ï¼Œåªæœ‰loç½‘å¡

      å¯ä»¥ä½¿ç”¨ `ip addr` æŸ¥çœ‹
      ```
      1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
         link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
         inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
      ```

   - container æ¨¡å¼ï¼š--net=container:NAME or ID
     
     åˆ›å»ºæ–°å®¹å™¨çš„æ—¶å€™ï¼Œé€šè¿‡--net containerå‚æ•°ï¼ŒæŒ‡å®šå…¶å’Œå·²ç»å­˜åœ¨çš„æŸä¸ªå®¹å™¨å…±äº«ä¸€ä¸ª Network Namespaceã€‚

     ```bash
     docker run -itd --net=container:é¢„å…±äº«çš„å®¹å™¨åç§°æˆ–id centos /bin/bash
     ```

     ![net=container](../_media/çŒé­”ç¬”è®°/docker/net=container.png)

   ---

   ```
   privileged=true 
   ```
  
   > åœ¨ Docker ä¸­ï¼Œ`privileged=true` è¡¨ç¤ºä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œå®¹å™¨ã€‚è¿™æ„å‘³ç€å®¹å™¨å†…çš„è¿›ç¨‹å°†æ‹¥æœ‰ä¸å®¿ä¸»æœºå‡ ä¹ç›¸åŒçš„æƒé™ï¼Œå¯ä»¥è®¿é—®å’Œæ“ä½œå®¿ä¸»æœºä¸Šçš„è®¾å¤‡ã€æ–‡ä»¶ç­‰èµ„æºã€‚
  

## èµ„æºé…é¢

- æ˜¾ç¤ºç³»ç»Ÿä¸­å„ä¸ªè¿›ç¨‹çš„èµ„æºå ç”¨çŠ¶å†µçš„å‘½ä»¤
   ```
   top
   ```

   æŒ‰ `1` å¯ä»¥å±•å¼€ CPU æ ¸å¿ƒä½¿ç”¨æƒ…å†µ

   ![top_cpu](../_media/çŒé­”ç¬”è®°/docker/top_cpu.png)

- æŸ¥çœ‹ docker èµ„æºä½¿ç”¨æƒ…å†µçš„å‘½ä»¤
   ```
   docker system df
   ```

---

- CPU
  - é™åˆ¶ CPU ä½¿ç”¨æƒé‡
     ```
     docker run --cpu-shares=1024 ubuntu /bin/sh
     ```
    - --cpu-shares : é»˜è®¤å€¼ 1024
     > æŸä¸ªå®¹å™¨æœ€ç»ˆèƒ½åˆ†é…åˆ°çš„ CPU èµ„æºå–å†³äºå®ƒçš„ cpu share å æ‰€æœ‰å®¹å™¨ cpu share æ€»å’Œçš„æ¯”ä¾‹

     > é€šè¿‡ cpu share å¯ä»¥è®¾ç½®å®¹å™¨ä½¿ç”¨ CPU çš„ä¼˜å…ˆçº§

     > è¿™ç§æŒ‰æƒé‡åˆ†é… CPU åªä¼šå‘ç”Ÿåœ¨ CPU èµ„æºç´§å¼ çš„æƒ…å†µä¸‹

     > åªå‘ç”Ÿåœ¨å®¹å™¨ç«äº‰åŒä¸€ä¸ª CPU çš„æ—¶é—´ç‰‡æ—¶æœ‰æ•ˆ

   - CPU æ ¸å¿ƒæ§åˆ¶
      æŒ‡å®šè¿è¡Œçš„ CPU æ ¸å¿ƒ

      ```
      docker run -itd --cpuset-cpus 0,1 ubuntu:14.04 /bin/bash
      ```

- å†…å­˜
   ```
   docker run -itd --memory 100m ubuntu:14.04 /bin/bash
   ```
    `-m` / `--memory`
    
    å•ä½ï¼š`b`, `k`, `m`, `g`

- IO (è¯»å†™é€Ÿåº¦)
   - å†™å…¥é€Ÿåº¦
     - --device-write-bps
         ```
         docker run -it  -v /ä¸»æœºå·:/å®¹å™¨å· --device /ä¸»æœºè®¾å¤‡:/å®¹å™¨è®¾å¤‡ --device-write-bps /ç›®æ ‡å†™å…¥:2mb centos  /bin/bash
         ```
   - è¯»å–é€Ÿåº¦
     - --device-read-bps

   - å•ä½ï¼š`kb`ã€`mb` æˆ– `gb`

- è‡ªåŠ¨é‡Šæ”¾å®¹å™¨èµ„æº
  ```
  docker run --rm -it centos /bin/bash
  ```
  
  å®¹å™¨é€€å‡ºåè‡ªåŠ¨åˆ é™¤å®¹å™¨